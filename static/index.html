<!--
    TODO: opacity depends on days of desease
    TODO: configurable from menu group characteristic
    TODO: rect radius depends
 -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
    <svg></svg>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script>
    // TODO: add inf_metadata setter
    // TODO: add plot of infected/health
    // TODO: add label for inf metadata

    

    function EpidPlot(parent_el, height, width) {
        this.margin = {top: 20, right: 80, bottom: 100, left: 30}

        this.height = height - this.margin.top - this.margin.bottom;
        this.width = width - this.margin.right - this.margin.left;
        this.plot = d3.select(parent_el).attr("height", this.height + 
                    this.margin.top + this.margin.bottom)
                .attr("width", this.width + 
                    this.margin.right + this.margin.left)
            .append("g")
                .attr("transform",
                    "translate(" + this.margin.left + 
                        "," + this.margin.top + ")");
    }

    EpidPlot.prototype.set_scales = function() {
        this.x_scale = d3.scaleLinear()
            .domain([0, this.inf_data.field_max_x])
            .range([0, this.width]);

        this.y_scale = d3.scaleLinear()
            .domain([0, this.inf_data.field_max_y])
            .range([this.height, 0]);

    }

    EpidPlot.prototype.draw_circles = function(group_data_array) {
        let t = d3.transition()
            .ease(d3.easeQuadInOut)
            .duration(1000);

        let circle_r = 10;

        group_data_array.map(
            (x, idx) => {x.id = idx}
        );

        let circles = this.plot.selectAll("circle")
                            .data(group_data_array);

        circles.enter()
            .append("circle")
            .attr("cx", d => this.x_scale(d[0][0]))
            .attr("cy", d => this.y_scale(d[0][1]))
            .attr("r", circle_r)
            .style("fill", "purple")
            .style("fill-opacity", 0)
            .attr("stroke", "black")
            .attr("stroke-width", 1.5);

        circles.transition(t)
            .style("fill-opacity", d =>  (d[2]/this.inf_data.inf_data.desease_duration).toFixed(1))
            .attr("cx", d => this.x_scale(d[0][0]))
            .attr("cy", d => this.y_scale(d[0][1]));

        let rects = this.plot.selectAll("rect").data(group_data_array.filter(
                d => d[1],
                d => d.id));

        rects.enter()
            .append("rect")
            .attr("x", d => this.x_scale(d[0][0] - this.x_scale.reverse(circle_r)))
            .attr("y", d => this.y_scale(d[0][1] - this.y_scale.reverse(circle_r)))
            .attr("height", 20)
            .attr("width", 20)
            .attr("stroke", "#2378ae")
            .style("fill", "none");
    
        // setTimeout(function() {
        //     rects
            
        // }, 1000)
        
        rects.exit()
            .remove();

        rects.transition(t)
            .attr("x", d => this.x_scale(d[0][0] - circle_r))
            .attr("y", d => this.y_scale(d[0][1] - circle_r));
    }

    EpidPlot.prototype.draw_axes = function() {
        let x_axis = d3.axisBottom()
                    .scale(this.x_scale)
                    .ticks(10);

        let y_axis = d3.axisLeft()
                    .scale(this.y_scale)
                    .ticks(10);

        this.plot.append("g")
            .call(x_axis)
            .attr('transform', 'translate(0,' + this.height+ ')');

        this.plot.append("g")
            .call(y_axis);
    }

    EpidPlot.prototype.initialize = function(metadata) {
        console.log(this);
        this.inf_data = metadata;
        this.set_scales();
        this.draw_axes();
    }

    let epid_plot = new EpidPlot("svg", 600, 600);

    let websocket = new WebSocket("ws://127.0.0.1:8081");

    let match_fun = {
        "ind_group": "draw_circles",
        "meta_data": "initialize"
    }

    websocket.onopen = (e) => {
        websocket.send("get_meta");
    }
    
    websocket.onmessage = (event) => {
        var jsonAnswer = JSON.parse(event.data);
        epid_plot[match_fun[jsonAnswer["name"]]](jsonAnswer["data"]);
    }

</script>
</body>
</html>